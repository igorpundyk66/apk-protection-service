# Техническое задание: Сервис шифрования и защиты APK-файлов

## 1. Описание проекта

Веб-сервис для автоматической защиты Android-приложений (APK-файлов) от реверс-инжиниринга, декомпиляции и анализа вредоносными сервисами. Пользователь загружает незащищенный APK-файл, сервис применяет множество техник обфускации и шифрования, после чего возвращает защищенный APK-файл.

## 2. Цели проекта

- **Основная цель**: Создать рабочий веб-сервис, который принимает APK-файл, обрабатывает его с использованием продвинутых методов защиты и возвращает защищенный APK-файл.
- **Защита от**: 
  - Реверс-инжиниринга и декомпиляции
  - Анализа антивирусными сервисами (GPZ и другие)
  - Статического и динамического анализа кода
  - Извлечения строк, ресурсов и логики приложения

## 3. Требования к функциональности

### 3.1 Frontend (Веб-интерфейс)

- **Загрузка файлов**:
  - Drag-and-drop интерфейс для загрузки APK-файлов
  - Кнопка выбора файла через файловый менеджер
  - Валидация: принимаются только файлы с расширением `.apk`
  - Отображение имени выбранного файла

- **Индикация процесса**:
  - Progress bar (прогресс-бар) для отображения процесса обработки
  - Статусные сообщения: "Обработка...", "Успешно", "Ошибка"
  - Примерное время обработки (может занять несколько минут)

- **Скачивание результата**:
  - Автоматическое скачивание защищенного APK-файла после завершения обработки
  - Имя файла: `protected_<original_name>.apk`

- **Дизайн**:
  - Современный, минималистичный интерфейс
  - Адаптивный дизайн (responsive) для мобильных устройств
  - Градиентный фон, плавные анимации
  - Информационный блок с описанием функций защиты

### 3.2 Backend (Серверная часть)

- **API Endpoint**: `POST /api/apk/upload`
  - Принимает: `multipart/form-data` с полем `file` (APK-файл)
  - Возвращает: Защищенный APK-файл в виде attachment

- **Обработка APK**:
  1. Прием и валидация загруженного файла
  2. Сохранение во временную директорию
  3. Применение методов защиты (см. раздел 4)
  4. Повторная подпись APK-файла
  5. Возврат защищенного APK-файла пользователю
  6. Очистка временных файлов

- **Обработка ошибок**:
  - Валидация формата файла
  - Обработка ошибок декомпиляции/рекомпиляции
  - Логирование ошибок для отладки
  - Возврат понятных сообщений об ошибках пользователю

- **Безопасность**:
  - Ограничение размера загружаемых файлов (например, до 100 МБ)
  - Изоляция обработки каждого файла (уникальные временные директории)
  - Автоматическая очистка временных файлов после обработки

## 4. Методы защиты APK

Для защиты APK-файлов используется инструмент **Obfuscapk** (https://github.com/ClaudiuGeorgiu/Obfuscapk), который применяет следующие техники:

### 4.1 Обфускация кода

1. **ClassRename**: Переименование классов в случайные имена
2. **MethodRename**: Переименование методов в случайные имена
3. **FieldRename**: Переименование полей в случайные имена
4. **CallIndirection**: Перенаправление вызовов методов через промежуточные методы
5. **Goto**: Случайная перестановка кода с использованием goto
6. **Nop**: Вставка "мусорного" кода (NOP-инструкций)
7. **ArithmeticBranch**: Добавление арифметических ветвлений

### 4.2 Шифрование

1. **ConstStringEncryption**: Шифрование строковых констант в коде
2. **ResStringEncryption**: Шифрование строк в ресурсах

### 4.3 Модификация структуры

1. **RandomManifest**: Случайная перестановка записей в AndroidManifest.xml
2. **Rebuild**: Пересборка приложения
3. **NewAlignment**: Выравнивание приложения
4. **NewSignature**: Повторная подпись с новым сертификатом

## 5. Технический стек

### 5.1 Backend

- **Язык**: Python 3.11+
- **Фреймворк**: Flask
- **Инструменты**:
  - **Obfuscapk**: Основной инструмент для обфускации и защиты APK
  - **apktool**: Декомпиляция и рекомпиляция APK
  - **apksigner**: Подпись APK-файлов
  - **keytool**: Генерация ключей для подписи

### 5.2 Frontend

- **Технологии**: HTML5, CSS3, JavaScript (Vanilla JS или React)
- **Стиль**: Современный градиентный дизайн
- **Функции**: Drag-and-drop, fetch API для загрузки файлов

### 5.3 Инфраструктура

- **Развертывание**: Vercel, Netlify, или собственный сервер
- **Хостинг backend**: Flask на Gunicorn/uWSGI или serverless (AWS Lambda, Google Cloud Functions)

## 6. Архитектура проекта

```
apk_encryptor_service/
├── backend/
│   ├── src/
│   │   ├── main.py                 # Главный файл Flask-приложения
│   │   ├── routes/
│   │   │   └── apk_processing.py   # API endpoint для обработки APK
│   │   └── utils/
│   │       └── obfuscator.py       # Логика обфускации с Obfuscapk
│   ├── .tmp/                       # Временные файлы (не коммитить)
│   ├── requirements.txt            # Python-зависимости
│   └── README.md                   # Инструкции по запуску backend
├── frontend/
│   ├── public/
│   │   └── index.html              # Главная страница
│   ├── src/
│   │   ├── App.js                  # Главный компонент React (если используется)
│   │   └── components/
│   │       └── FileUpload.js       # Компонент загрузки файлов
│   └── package.json                # npm-зависимости
└── docs/
    ├── APK_ENCRYPTOR_TZ.md         # Техническое задание
    ├── RESEARCH.md                 # Исследование методов защиты
    └── IMPLEMENTATION_PLAN.md      # План реализации
```

## 7. Этапы разработки

### Этап 1: Исследование (Завершен)
- Изучение методов обфускации и защиты APK
- Анализ инструментов: Obfuscapk, ProGuard, DexGuard
- Выбор Obfuscapk как основного инструмента

### Этап 2: Backend (В процессе)
- Создание Flask-приложения
- Интеграция Obfuscapk
- Реализация API endpoint для загрузки и обработки APK
- Тестирование обработки APK

### Этап 3: Frontend (Завершен)
- Создание веб-интерфейса с drag-and-drop
- Интеграция с backend API
- Добавление индикации прогресса

### Этап 4: Интеграция и тестирование (В процессе)
- Тестирование полного цикла: загрузка → обработка → скачивание
- Отладка ошибок
- Оптимизация производительности

### Этап 5: Развертывание
- Настройка production-окружения
- Развертывание на хостинге
- Настройка HTTPS и безопасности

## 8. Текущие проблемы и решения

### Проблема 1: Ошибка 405 Method Not Allowed
**Описание**: При отправке POST-запроса на `/api/apk/upload` возникает ошибка 405.

**Возможные причины**:
1. Blueprint не зарегистрирован корректно
2. Проблема с обработкой `multipart/form-data` в Flask
3. Конфликт маршрутов

**Решение**:
- Проверить регистрацию Blueprint в `main.py`
- Убедиться, что метод `POST` явно указан в декораторе `@route`
- Проверить логи Flask для детальной информации
- Попробовать упростить endpoint для тестирования

### Проблема 2: Создание тестового APK
**Описание**: Сложность создания минимального валидного APK для тестирования.

**Решение**:
- Использовать `apktool` для создания минимального APK из Smali-кода
- Подписать APK с помощью `apksigner` и debug keystore
- Альтернатива: скачать готовый минимальный APK из открытых источников

## 9. Критерии успеха

- [ ] Пользователь может загрузить APK-файл через веб-интерфейс
- [ ] Backend успешно обрабатывает APK с использованием Obfuscapk
- [ ] Защищенный APK автоматически скачивается после обработки
- [ ] Защищенный APK проходит базовую проверку (можно установить на устройство)
- [ ] Сервис развернут и доступен по публичному URL

## 10. Дальнейшее развитие

- **Аутентификация**: Добавление регистрации и входа пользователей
- **История обработки**: Сохранение истории обработанных APK
- **Настройки защиты**: Возможность выбора методов обфускации
- **Анализ защищенности**: Отчет о примененных методах защиты
- **API для интеграции**: REST API для автоматизации защиты APK
- **Поддержка AAB**: Обработка Android App Bundle (AAB) файлов

## 11. Контакты и ресурсы

- **Obfuscapk GitHub**: https://github.com/ClaudiuGeorgiu/Obfuscapk
- **APKTool**: https://ibotpeaches.github.io/Apktool/
- **Android Developer Docs**: https://developer.android.com/
